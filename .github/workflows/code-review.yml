name: Code Review

on:
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  # AI ì½”ë“œ ë¦¬ë·°
  ai-review:
    name: AI Code Review
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get changed files
        id: changed-files
        uses: tj-actions/changed-files@v40
        with:
          files: |
            **/*.ts
            **/*.tsx
            **/*.js
            **/*.jsx

      - name: AI Code Review
        uses: actions/github-script@v6
        if: steps.changed-files.outputs.any_changed == 'true'
        with:
          script: |
            const changedFiles = '${{ steps.changed-files.outputs.all_changed_files }}'.split(' ');
            
            // ì½”ë“œ ë¦¬ë·° ì²´í¬ë¦¬ìŠ¤íŠ¸
            const reviewChecklist = {
              security: [
                'SQL injection ë°©ì§€',
                'XSS ì·¨ì•½ì  í™•ì¸',
                'API í‚¤ ë…¸ì¶œ í™•ì¸',
                'ì¸ì¦/ì¸ê°€ ì²˜ë¦¬',
                'Input validation'
              ],
              performance: [
                'ë¶ˆí•„ìš”í•œ re-render ë°©ì§€',
                'ë©”ëª¨ì´ì œì´ì…˜ ì‚¬ìš©',
                'ë²ˆë“¤ í¬ê¸° ìµœì í™”',
                'ì´ë¯¸ì§€ ìµœì í™”',
                'API í˜¸ì¶œ ìµœì í™”'
              ],
              quality: [
                'TypeScript íƒ€ìž… ì•ˆì „ì„±',
                'ì—ëŸ¬ í•¸ë“¤ë§',
                'ì½”ë“œ ì¤‘ë³µ ì œê±°',
                'ë„¤ì´ë° ì»¨ë²¤ì…˜',
                'ì£¼ì„ ë° ë¬¸ì„œí™”'
              ],
              testing: [
                'í…ŒìŠ¤íŠ¸ ì»¤ë²„ë¦¬ì§€',
                'Edge case ì²˜ë¦¬',
                'ì—ëŸ¬ ì‹œë‚˜ë¦¬ì˜¤ í…ŒìŠ¤íŠ¸'
              ]
            };
            
            let comment = '## ðŸ¤– AI Code Review\n\n';
            comment += '### ðŸ“‹ Review Checklist\n\n';
            
            Object.entries(reviewChecklist).forEach(([category, items]) => {
              comment += `#### ${category.charAt(0).toUpperCase() + category.slice(1)}\n`;
              items.forEach(item => {
                comment += `- [ ] ${item}\n`;
              });
              comment += '\n';
            });
            
            comment += '### ðŸ“ Changed Files\n';
            changedFiles.forEach(file => {
              comment += `- \`${file}\`\n`;
            });
            
            comment += '\n### ðŸ’¡ Recommendations\n';
            comment += '- Review the checklist above for all changed files\n';
            comment += '- Ensure all tests pass before merging\n';
            comment += '- Consider performance implications of changes\n';
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });

  # ì˜ì¡´ì„± ê²€ì‚¬
  dependency-review:
    name: Dependency Review
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Dependency Review
        uses: actions/dependency-review-action@v3
        with:
          fail-on-severity: moderate

  # ë¸Œëžœì¹˜ ë³´í˜¸ ê·œì¹™ í™•ì¸
  branch-protection:
    name: Branch Protection Check
    runs-on: ubuntu-latest
    steps:
      - name: Check PR base branch
        if: github.base_ref == 'main'
        run: |
          echo "::notice::This PR targets the main branch. Ensure all checks pass!"
          
      - name: Check commit messages
        uses: actions/github-script@v6
        with:
          script: |
            const commits = await github.rest.pulls.listCommits({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: context.issue.number
            });
            
            const conventionalCommitPattern = /^(feat|fix|docs|style|refactor|perf|test|chore|build|ci)(\(.+\))?: .+/;
            const invalidCommits = commits.data.filter(commit => 
              !conventionalCommitPattern.test(commit.commit.message.split('\n')[0])
            );
            
            if (invalidCommits.length > 0) {
              core.setFailed(`Found ${invalidCommits.length} commits not following conventional commit format`);
              invalidCommits.forEach(commit => {
                console.log(`Invalid: ${commit.commit.message.split('\n')[0]}`);
              });
            }
